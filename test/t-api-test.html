<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../iron-meta/iron-meta.html">
    <link rel="import" href="../t-shopping-cart-add-api.html">
    <link rel="import" href="../t-air-results-api.html">
  </head>
  <body>
    <!-- use the document as a place to set up your fixtures -->
    <test-fixture id="resultsFixture">
      <template>
        <iron-meta key="Eva.contextName" value="mystiquedemo" type="globals"></iron-meta>
        <iron-meta key="Eva.apiBaseUrl" value="http://demo.travelnxt.com/api/" type="globals"></iron-meta>
        <t-air-results-api id="resultsApi"></t-air-results-api>
        <t-shopping-cart-add-api></t-shopping-cart-add-api>
      </template>
    </test-fixture>
    <script>
      suite('<results>', function() {
        var resultsFixture;
        var resultsFixtureNode;
        var resultsApiComp;
        var cartApiComp;
        setup(function() {
          //1. load element and get element access 
          resultsFixture = fixture('resultsFixture');
          resultsFixtureNode = Polymer.dom(resultsFixture.root);
          resultsApiComp = resultsFixtureNode.querySelector('t-air-results-api');
          cartApiComp = resultsFixtureNode.querySelector('t-shopping-cart-add-api');
        });

        test('should fire air search and add first inventory to shopping cart', function(done) { 
                    
          //2. wait till auth token is ready
          if(resultsApiComp.isReady){
            fireSearch();
          }
          else{      
            resultsApiComp.addEventListener('t-auth-api-success', function(e) {
              fireSearch(); 
            });
          }
          
          //3. api success handlers setup
          resultsApiComp.addEventListener('t-air-results-api-success', function(e) {            
            assert.isNotNull(e.detail.itineraries, 'Got results');
            fireAddToCart(e.detail.searchId, e.detail.inventories[0].id)
          });

          cartApiComp.addEventListener('t-shopping-cart-add-api-success', function(e){
            assert.equal(e.detail.status.isSuccessful, true);            
            done();
          })

          //4. helpers to fire api calls
          function fireSearch(){
            document.querySelector('body').dispatchEvent(new CustomEvent('t-air-results', {
                  detail: {
                      criteria: {
                      adultCount: 1,
                      adultAges: [],
                      leg1Origin: 'LAS',
                      leg1Destination: 'LAX',
                      leg1Date: '05/25/2016',
                      tripType: 'OneWay'
                    }
                  }
                })
              );
          }

          function fireAddToCart(searchId, inventoryId) {
            document.querySelector('body').dispatchEvent(new CustomEvent('t-shopping-cart-add', {
                  detail: {
                      searchId: searchId,
                      inventoryId: inventoryId
                  }
                })
              );
          }

          
        });
      });
    </script>
  </body>
</html>